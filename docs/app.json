[{"name":"app.R","content":"library(shiny)\nlibrary(dplyr)\nlibrary(CDCPLACES)\nlibrary(shinylive)\nlibrary(leaflet)\nlibrary(readr)\nlibrary(sf)\nlibrary(data.table)\nlibrary(shinythemes)\n\n# mi_census <- get_places(geography = \"census\", state = \"MI\", geometry = T) %>%\n#   mutate(locationname = as.character(locationname),\n#          data_value_lab = data_value / 100) %>%\n#   select(category, locationname, measure, data_value, year, low_confidence_limit, high_confidence_limit, data_value_lab)\n\n# mi_county <- get_places(geography = \"county\", state = \"MI\", geometry = T) %>%\n#   mutate(locationname = as.character(locationname),\n#          data_value_lab = data_value / 100) %>%\n#   select(category, locationname, measure, data_value, year, low_confidence_limit, high_confidence_limit, data_value_lab)\n# \n# sf::st_write(mi_census, \"data/mi_census.shp\")\n# \n# sf::st_write(mi_county, \"data/mi_county.shp\")\n\n# dict <- get_dictionary() |> select(measure_full_name, category_name)\n# \n# write_csv(dict, \"data/dict.csv\")\n\ndict <- read_csv(\"data/dict.csv\") |> \n  as.data.table()\n\n\n\n# mi_county <- sf::st_read(\"data/mi_county.shp\")\n\nmeasures_select <-  unique(dict$measure_full_name)\n\ncategory_select <-  unique(dict$category_name)\n\nmi_county <- sf::st_read(\"data/mi_county.shp\")\n\n#mi_census <- sf::st_read(\"data/mi_census.shp\") #|> \n#  st_transform(mi_census, '+proj=longlat +datum=WGS84')\n\n# Define UI for application that draws a histogram\nui <- fluidPage(\n  theme = shinythemes::shinytheme(\"yeti\"),\n  \n  # Application title\n  titlePanel(\"MI PLACES Data Explorer\"),\n  \n  # Sidebar with a slider input for number of bins \n  sidebarLayout(\n    sidebarPanel(\n      \n      selectInput(\"category\",\n                  h3(\"Select a category:\"),\n                  choices = category_select),\n      uiOutput(\"measures\"),\n      h3(\"About\"),\n      h4(\"This app was created to help explore data from the Centers for Disease Control and Prevention's 'PLACES' data set. This app shows PLACES data in Michigan Counties.\"),\n      h4(\"This data was pulled from the\", tags$a(href = \"https://github.com/brendensm/CDCPLACES\", \"'CDCPLACES' R Package.\"), \"Use the menus below to select a category and measure of interest.\"),\n      # selectInput(\"measure\",\n      #             h3(\"Select a measure:\"),\n      \n      #choices = measures_select),\n      h5(\"Rate shown is crude and unadjusted for age. Confidence limits are shown in parentheses.\")\n      \n    ),\n    \n    # Show a plot of the generated distribution\n    mainPanel(\n      leafletOutput(\"map\", height = \"675\", width = \"800\"),\n      textOutput(\"datasource\")\n    )\n  )\n)\n\n# Define server logic required to draw a histogram\nserver <- function(input, output) {\n  \n  # filtered_measures <- reactive({\n  #   filter(lansing, category == input$category) %>% unique()\n  # })\n  \n  output$measures = renderUI({\n    measures_select1 <- unique(dict[category_name == input$category])\n    measures_select2 <- measures_select1$measure_full_name\n    selectInput('measure', h3('Select a measure:'), measures_select2)\n  })\n  \n  group_to_map <- reactive({\n    # filter(mi_census, measure == input$measure)\n    mi_county[mi_county$measure == input$measure,]\n  })\n  \n  # Initialize the map object, centered on the Michigan counties\n  output$map <- renderLeaflet({\n    \n    leaflet(options = leafletOptions(zoomControl = TRUE)) %>%\n      addTiles() %>%\n      #  addProviderTiles(\"Stamen.TonerHybrid\") %>%\n      setView(lng = -84.752663,\n              lat = 43.989807,\n              zoom = 7)\n    #, \n  })\n  \n  output$datasource <- renderText({\n    release <- unique(group_to_map()$year)\n    \n    paste0(\"Data source: CDC PLACES release 2023. Behavioral Risk Factor Surveillance Survey (BRFSS), \", release, \".\")\n  })\n  \n  observeEvent(input$measure, {\n    \n    pal <- colorNumeric(\"viridis\", group_to_map()$dt_vl_l)\n    \n    leafletProxy(\"map\") %>%\n      clearShapes() %>%\n      clearControls() %>%\n      addPolygons(data = group_to_map(),\n                  color = ~pal(dt_vl_l),\n                  weight = 0.5,\n                  fillOpacity = 0.5,\n                  smoothFactor = 0.2,\n                  label = paste0(group_to_map()$data_vl, \", (\", group_to_map()$lw_cnf_, \"-\", group_to_map()$hgh_cn_, \")\")\n      ) %>%\n      # leaflegend::addLegendNumeric(pal= pal,\n      #                 shape = \"rect\",\n      #                 orientation = \"horizontal\",\n      #                 values = group_to_map()$data_value,\n      #                 width = 250,\n      #                 height = 25,\n      #                 \n      #                 title = paste0(unique(group_to_map()$measure), \" (%)\"),\n      #                fillOpacity = 1)\n      addLegend(\n        position = \"bottomright\",\n        pal = pal,\n        bins = 9,\n        values = group_to_map()$dt_vl_l,\n        labFormat = scales::percent\n        # title = paste0(unique(group_to_map()$measure), \" (%)\")\n      )\n  })\n  \n}\n\n# Run the application \nshinyApp(ui = ui, server = server)","type":"text"}]
